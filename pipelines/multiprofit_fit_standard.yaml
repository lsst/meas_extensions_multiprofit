description: |
  Default configuration for MultiProFit in LSST pipelines
parameters:
  add_point_source: False
  fix_centroid: False
  prior_axrat_stddev: null
  sersic_init_table: deepCoadd_Exp_multiprofit
  use_cell_coadds: False
  use_shapelet_psf: False
tasks:
  fitDeepCoaddPsfGaussians:
    class: lsst.meas.extensions.multiprofit.pipetasks_fit.MultiProFitCoaddPsfFitTask
    config:
      use_cell_coadds: parameters.use_cell_coadds
  fitDeblendedObjectsExp:
    class: lsst.meas.extensions.multiprofit.pipetasks_fit.MultiProFitCoaddExpFitTask

    config:
      use_cell_coadds: parameters.use_cell_coadds
      fit_coadd_multiband.fit_psmodel_final: True

      python: |
        config.finalize(
          add_point_source=parameters.add_point_source,
          fix_centroid=parameters.fix_centroid,
          use_shapelet_psf=parameters.use_shapelet_psf,
          prior_axrat_stddev=parameters.prior_axrat_stddev,
        )
  fitDeblendedObjectsSersic:
    class: lsst.meas.extensions.multiprofit.pipetasks_fit.MultiProFitCoaddSersicFitTask
    config:
      use_cell_coadds: parameters.use_cell_coadds
      python: |
        from lsst.meas.extensions.multiprofit.pipetasks_fit import MakeCachedChainedInitializerAction
        config.finalize(
          add_point_source=parameters.add_point_source,
          fix_centroid=parameters.fix_centroid,
          use_shapelet_psf=parameters.use_shapelet_psf,
          prior_axrat_stddev=parameters.prior_axrat_stddev,
        )
        if parameters.sersic_init_table:
          config.inputs_init = {
            parameters.sersic_init_table: InputConfig(
              doc=f"{parameters.sersic_init_table} fit parameters",
              is_multiband=True,
            )
          }
          config.fit_coadd_multiband.action_initializer = MakeCachedChainedInitializerAction()
contracts:
  - fitDeepCoaddPsfGaussians.use_cell_coadds == fitDeblendedObjectsExp.use_cell_coadds
  - fitDeepCoaddPsfGaussians.use_cell_coadds == fitDeblendedObjectsSersic.use_cell_coadds
